

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>建立一个前端 &mdash; feathers docs v2019.06.21 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="写测试" href="testing.html" />
    <link rel="prev" title="处理数据" href="processing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> feathers docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Feathers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../readme.html">指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/index.html">Feathers 基础功能</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">创建聊天应用程序</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="readme.html">创建聊天应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="creating.html">创建应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html">创建服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="authentication.html">添加身份验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="processing.html">处理数据</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">建立一个前端</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#set-up-the-index-page">Set up the index page</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connect-to-the-api">Connect to the API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#base-and-user-message-list-html">Base and user/message list HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="#displaying-the-login-signup-or-chat-page">Displaying the login/signup or chat page</a></li>
<li class="toctree-l4"><a class="reference internal" href="#login-and-signup">Login and signup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#real-time-and-sending-messages">Real-time and sending messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#whats-next">What’s next?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">写测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../auth/index.html">身份验证指南和食谱</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/index.html">高级指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frameworks/readme.html">与前端框架集成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrating.html">Feathers v3（秃鹰）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SECURITY.html">Feathers 安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Ecosystem/index.html">生态系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help/readme.html">救命！</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/readme.html">常问问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/readme.html">特约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">有许可证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../.github/index.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Summary.html">摘要</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">feathers docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">指南</a> &raquo;</li>
        
          <li><a href="index.html">创建聊天应用程序</a> &raquo;</li>
        
      <li>建立一个前端</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/guides/chat/frontend.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building-a-frontend">
<h1>建立一个前端<a class="headerlink" href="#building-a-frontend" title="永久链接至标题">¶</a></h1>
<p>As we have seen in the <span class="xref std std-doc">basics/readme</span>, Feathers
works great in the browser and comes with <a class="reference internal" href="../basics/clients.html"><span class="doc">client services</span></a> that allow to easily connect to a
Feathers server.</p>
<p>In this chapter we will create a real-time chat frontend with signup and
login using modern plain JavaScript. As with the <a class="reference internal" href="../basics/readme.html"><span class="doc">basics guide</span></a>,
it will only work in the latest versions
of Chrome, Firefox, Safari and Edge since we won’t be using a transpiler
like <a class="reference external" href="http://babeljs.io/">Babel</a>. The final version can be found
<a class="reference external" href="https://github.com/feathersjs/feathers-chat/tree/master/public/vanilla">here</a>.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>We will not be using a frontend framework so we can focus
on what Feathers is all about. Feathers is framework agnostic and can
be used with any frontend framework like React, VueJS or Angular. For
more information see the <a class="reference internal" href="../frameworks/readme.html"><span class="doc">frameworks section</span></a>.</p>
</div>
<div class="section" id="set-up-the-index-page">
<h2>Set up the index page<a class="headerlink" href="#set-up-the-index-page" title="永久链接至标题">¶</a></h2>
<p>We are already serving the static files in the <code class="docutils literal notranslate"><span class="pre">public</span></code> folder and
have a placeholder page in <code class="docutils literal notranslate"><span class="pre">public/index.html</span></code>. Let’s update it to the
following:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span>
      <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Vanilla JavaScript Feathers Chat<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;favicon.ico&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;//cdn.rawgit.com/feathersjs/feathers-chat/v0.2.0/public/base.css&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;//cdn.rawgit.com/feathersjs/feathers-chat/v0.2.0/public/chat.css&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;flex flex-column&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//unpkg.com/@feathersjs/client@^3.0.0/dist/feathers.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;app.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>This will load our chat CSS style, add a container div <code class="docutils literal notranslate"><span class="pre">#app</span></code> and load
several libraries:</p>
<ul class="simple">
<li><p>The <span class="xref std std-doc">basics/clients</span> (since we
are not using a module loader like Webpack or Browserify)</p></li>
<li><p>Socket.io provided by the chat API</p></li>
<li><p><a class="reference external" href="https://momentjs.com/">MomentJS</a> to format dates</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">app.js</span></code> for our code to live in</p></li>
</ul>
<p>Let’s create <code class="docutils literal notranslate"><span class="pre">public/app.js</span></code> where all the following code will live
(with each code sample added to the end of that file).</p>
</div>
<div class="section" id="connect-to-the-api">
<h2>Connect to the API<a class="headerlink" href="#connect-to-the-api" title="永久链接至标题">¶</a></h2>
<p>We’ll start with the most important thing first, the connection to our
Feathers API. We already learned how Feathers can be used on the client
in the <span class="xref std std-doc">basics/readme</span>. Here, we do pretty much
the same thing: Establish a Socket connection and initialize a new
Feathers application. We also set up the authentication client for
later:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Establish a Socket.io connection</span>
<span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">();</span>
<span class="c1">// Initialize our Feathers client application through Socket.io</span>
<span class="c1">// with hooks and authentication.</span>
<span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">feathers</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">feathers</span><span class="p">.</span><span class="nx">socketio</span><span class="p">(</span><span class="nx">socket</span><span class="p">));</span>
<span class="c1">// Use localStorage to store our login token</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">feathers</span><span class="p">.</span><span class="nx">authentication</span><span class="p">({</span>
  <span class="nx">storage</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>This allows us to talk to the chat API through websockets, for real-time
updates.</p>
</div>
<div class="section" id="base-and-user-message-list-html">
<h2>Base and user/message list HTML<a class="headerlink" href="#base-and-user-message-list-html" title="永久链接至标题">¶</a></h2>
<p>Next, we have to define some static and dynamic HTML that we can insert
into the page when we want to show the login page (which also doubles as
the signup page) and the actual chat interface:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Login screen</span>
<span class="kr">const</span> <span class="nx">loginHTML</span> <span class="o">=</span> <span class="sb">`&lt;main class=&quot;login container&quot;&gt;</span>
<span class="sb">  &lt;div class=&quot;row&quot;&gt;</span>
<span class="sb">    &lt;div class=&quot;col-12 col-6-tablet push-3-tablet text-center heading&quot;&gt;</span>
<span class="sb">      &lt;h1 class=&quot;font-100&quot;&gt;Log in or signup&lt;/h1&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">  &lt;div class=&quot;row&quot;&gt;</span>
<span class="sb">    &lt;div class=&quot;col-12 col-6-tablet push-3-tablet col-4-desktop push-4-desktop&quot;&gt;</span>
<span class="sb">      &lt;form class=&quot;form&quot;&gt;</span>
<span class="sb">        &lt;fieldset&gt;</span>
<span class="sb">          &lt;input class=&quot;block&quot; type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot;email&quot;&gt;</span>
<span class="sb">        &lt;/fieldset&gt;</span>

<span class="sb">        &lt;fieldset&gt;</span>
<span class="sb">          &lt;input class=&quot;block&quot; type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot;password&quot;&gt;</span>
<span class="sb">        &lt;/fieldset&gt;</span>

<span class="sb">        &lt;button type=&quot;button&quot; id=&quot;login&quot; class=&quot;button button-primary block signup&quot;&gt;</span>
<span class="sb">          Log in</span>
<span class="sb">        &lt;/button&gt;</span>

<span class="sb">        &lt;button type=&quot;button&quot; id=&quot;signup&quot; class=&quot;button button-primary block signup&quot;&gt;</span>
<span class="sb">          Sign up and log in</span>
<span class="sb">        &lt;/button&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">&lt;/main&gt;`</span><span class="p">;</span>

<span class="c1">// Chat base HTML (without user list and messages)</span>
<span class="kr">const</span> <span class="nx">chatHTML</span> <span class="o">=</span> <span class="sb">`&lt;main class=&quot;flex flex-column&quot;&gt;</span>
<span class="sb">  &lt;header class=&quot;title-bar flex flex-row flex-center&quot;&gt;</span>
<span class="sb">    &lt;div class=&quot;title-wrapper block center-element&quot;&gt;</span>
<span class="sb">      &lt;img class=&quot;logo&quot; src=&quot;http://feathersjs.com/img/feathers-logo-wide.png&quot;</span>
<span class="sb">        alt=&quot;Feathers Logo&quot;&gt;</span>
<span class="sb">      &lt;span class=&quot;title&quot;&gt;Chat&lt;/span&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/header&gt;</span>

<span class="sb">  &lt;div class=&quot;flex flex-row flex-1 clear&quot;&gt;</span>
<span class="sb">    &lt;aside class=&quot;sidebar col col-3 flex flex-column flex-space-between&quot;&gt;</span>
<span class="sb">      &lt;header class=&quot;flex flex-row flex-center&quot;&gt;</span>
<span class="sb">        &lt;h4 class=&quot;font-300 text-center&quot;&gt;</span>
<span class="sb">          &lt;span class=&quot;font-600 online-count&quot;&gt;0&lt;/span&gt; users</span>
<span class="sb">        &lt;/h4&gt;</span>
<span class="sb">      &lt;/header&gt;</span>

<span class="sb">      &lt;ul class=&quot;flex flex-column flex-1 list-unstyled user-list&quot;&gt;&lt;/ul&gt;</span>
<span class="sb">      &lt;footer class=&quot;flex flex-row flex-center&quot;&gt;</span>
<span class="sb">        &lt;a href=&quot;#&quot; id=&quot;logout&quot; class=&quot;button button-primary&quot;&gt;</span>
<span class="sb">          Sign Out</span>
<span class="sb">        &lt;/a&gt;</span>
<span class="sb">      &lt;/footer&gt;</span>
<span class="sb">    &lt;/aside&gt;</span>

<span class="sb">    &lt;div class=&quot;flex flex-column col col-9&quot;&gt;</span>
<span class="sb">      &lt;main class=&quot;chat flex flex-column flex-1 clear&quot;&gt;&lt;/main&gt;</span>

<span class="sb">      &lt;form class=&quot;flex flex-row flex-space-between&quot; id=&quot;send-message&quot;&gt;</span>
<span class="sb">        &lt;input type=&quot;text&quot; name=&quot;text&quot; class=&quot;flex flex-1&quot;&gt;</span>
<span class="sb">        &lt;button class=&quot;button-primary&quot; type=&quot;submit&quot;&gt;Send&lt;/button&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">&lt;/main&gt;`</span><span class="p">;</span>

<span class="c1">// Add a new user to the list</span>
<span class="kr">const</span> <span class="nx">addUser</span> <span class="o">=</span> <span class="nx">user</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">userList</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.user-list&#39;</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">userList</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add the user to the list</span>
    <span class="nx">userList</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="s1">&#39;beforeend&#39;</span><span class="p">,</span> <span class="sb">`&lt;li&gt;</span>
<span class="sb">      &lt;a class=&quot;block relative&quot; href=&quot;#&quot;&gt;</span>
<span class="sb">        &lt;img src=&quot;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">&quot; alt=&quot;&quot; class=&quot;avatar&quot;&gt;</span>
<span class="sb">        &lt;span class=&quot;absolute username&quot;&gt;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">      &lt;/a&gt;</span>
<span class="sb">    &lt;/li&gt;`</span><span class="p">);</span>

    <span class="c1">// Update the number of users</span>
    <span class="kr">const</span> <span class="nx">userCount</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.user-list li&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.online-count&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">userCount</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Renders a new message and finds the user that belongs to the message</span>
<span class="kr">const</span> <span class="nx">addMessage</span> <span class="o">=</span> <span class="nx">message</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Find the user belonging to this message or use the anonymous user if not found</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">chat</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.chat&#39;</span><span class="p">);</span>
  <span class="c1">// Escape HTML</span>
  <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">text</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">chat</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chat</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span> <span class="s1">&#39;beforeend&#39;</span><span class="p">,</span> <span class="sb">`&lt;div class=&quot;message flex flex-row&quot;&gt;</span>
<span class="sb">      &lt;img src=&quot;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">&quot; alt=&quot;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">&quot; class=&quot;avatar&quot;&gt;</span>
<span class="sb">      &lt;div class=&quot;message-wrapper&quot;&gt;</span>
<span class="sb">        &lt;p class=&quot;message-header&quot;&gt;</span>
<span class="sb">          &lt;span class=&quot;username font-600&quot;&gt;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">          &lt;span class=&quot;sent-date font-300&quot;&gt;</span><span class="si">${</span><span class="nx">moment</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;MMM Do, hh:mm:ss&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">        &lt;/p&gt;</span>
<span class="sb">        &lt;p class=&quot;message-content font-300&quot;&gt;</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">&lt;/p&gt;</span>
<span class="sb">      &lt;/div&gt;</span>
<span class="sb">    &lt;/div&gt;`</span><span class="p">);</span>

    <span class="nx">chat</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">scrollHeight</span> <span class="o">-</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This will add the following variables and functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">loginHTML</span></code> contains some static HTML for the login/signup page</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chatHTML</span></code> contains the main chat page content (once a user is
logged in)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">addUser(user)</span></code> is a function to add a new user to the user list on
the left</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">addMessage(message)</span></code> is a function to add a new message to the
list. It will also make sure that we always scroll to the bottom of
the message list as messages get added</p></li>
</ul>
</div>
<div class="section" id="displaying-the-login-signup-or-chat-page">
<h2>Displaying the login/signup or chat page<a class="headerlink" href="#displaying-the-login-signup-or-chat-page" title="永久链接至标题">¶</a></h2>
<p>Next, we’ll add two functions to display the login and chat page, where
we’ll also add a list of the 25 newest chat messages and the registered
users.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Show the login page</span>
<span class="kr">const</span> <span class="nx">showLogin</span> <span class="o">=</span> <span class="p">(</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.login&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.heading&#39;</span><span class="p">).</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="s1">&#39;beforeend&#39;</span><span class="p">,</span> <span class="sb">`&lt;p&gt;There was an error: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">&lt;/p&gt;`</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">loginHTML</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Shows the chat page</span>
<span class="kr">const</span> <span class="nx">showChat</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">chatHTML</span><span class="p">;</span>

  <span class="c1">// Find the latest 25 messages. They will come with the newest first</span>
  <span class="c1">// which is why we have to reverse before adding them</span>
  <span class="kr">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
      <span class="nx">$limit</span><span class="o">:</span> <span class="mi">25</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// We want to show the newest message last</span>
  <span class="nx">messages</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">addMessage</span><span class="p">);</span>

  <span class="c1">// Find all users</span>
  <span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">();</span>

  <span class="nx">users</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">addUser</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">showLogin(error)</span></code> will either show the content of loginHTML or, if
the login page is already showing, add an error message. This will
happen when you try to log in with invalid credentials or sign up
with a user that already exists.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">showChat()</span></code> does several things. First, we add the static chatHTML
to the page. Then we get the latest 25 messages from the messages
Feathers service (this is the same as the <code class="docutils literal notranslate"><span class="pre">/messages</span></code> endpoint of
our chat API) using the Feathers query syntax. Since the list will
come back with the newest message first, we need to reverse the data.
Then we add each message by calling our <code class="docutils literal notranslate"><span class="pre">addMessage</span></code> function so
that it looks like a chat app should — with old messages getting
older as you scroll up. After that we get a list of all registered
users to show them in the sidebar by calling addUser.</p></li>
</ul>
</div>
<div class="section" id="login-and-signup">
<h2>Login and signup<a class="headerlink" href="#login-and-signup" title="永久链接至标题">¶</a></h2>
<p>Alright. Now we can show the login page (including an error message when
something goes wrong) and if we are logged in call the <code class="docutils literal notranslate"><span class="pre">showChat</span></code> we
defined above. We’ve built out the UI, now we have to add the
functionality to actually allow people to sign up, log in and also log
out.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Retrieve email/password object from the login/signup page</span>
<span class="kr">const</span> <span class="nx">getCredentials</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;[name=&quot;email&quot;]&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;[name=&quot;password&quot;]&#39;</span><span class="p">).</span><span class="nx">value</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Log in either using the given email/password or the token from storage</span>
<span class="kr">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">credentials</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">credentials</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Try to authenticate using the JWT from localStorage</span>
      <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// If we get login information, add the strategy we want to use for login</span>
      <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({</span> <span class="nx">strategy</span><span class="o">:</span> <span class="s1">&#39;local&#39;</span> <span class="p">},</span> <span class="nx">credentials</span><span class="p">);</span>

      <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// If successful, show the chat page</span>
    <span class="nx">showChat</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If we got an error, show the login page</span>
    <span class="nx">showLogin</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="nx">ev</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">&#39;signup&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// For signup, create a new user and then log them in</span>
    <span class="kr">const</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="nx">getCredentials</span><span class="p">();</span>

    <span class="c1">// First create the user</span>
    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span><span class="nx">credentials</span><span class="p">);</span>
    <span class="c1">// If successful log them in</span>
    <span class="nx">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">credentials</span><span class="p">);</span>

    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">case</span> <span class="s1">&#39;login&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getCredentials</span><span class="p">();</span>

    <span class="nx">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>

    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">case</span> <span class="s1">&#39;logout&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">loginHTML</span><span class="p">;</span>

    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">getCredentials()</span></code> gets us the values of the username (email) and
password fields from the login/signup page to be used directly with
Feathers authentication.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">login(credentials)</span></code> will either authenticate the credentials
returned by getCredentials against our Feathers API using the local
authentication strategy (e.g. username and password) or, if no
credentials are given, try and use the JWT stored in localStorage.
This will try and get the JWT from localStorage first where it is put
automatically once you log in successfully so that we don’t have to
log in every time we visit the chat. Only if that doesn’t work it
will show the login page. Finally, if the login was successful it
will show the chat page.</p></li>
<li><p>We also added click event listeners for three buttons. <code class="docutils literal notranslate"><span class="pre">#login</span></code>
will get the credentials and just log in with those. Clicking
<code class="docutils literal notranslate"><span class="pre">#signup</span></code> will signup and log in at the same time. It will first
create a new user on our API and then log in with that same user
information. Finally, <code class="docutils literal notranslate"><span class="pre">#logout</span></code> will forget the JWT and then show
the login page again.</p></li>
</ul>
</div>
<div class="section" id="real-time-and-sending-messages">
<h2>Real-time and sending messages<a class="headerlink" href="#real-time-and-sending-messages" title="永久链接至标题">¶</a></h2>
<p>In the last step we will add functionality to send new message and make
the user and message list update in real-time.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="nx">ev</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;send-message&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This is the message text input field</span>
    <span class="kr">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;[name=&quot;text&quot;]&#39;</span><span class="p">);</span>

    <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="c1">// Create a new message and then clear the input field</span>
    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">text</span><span class="o">:</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">});</span>

    <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Listen to created events and add the new message in real-time</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="nx">addMessage</span><span class="p">);</span>

<span class="c1">// We will also see when new users get created in real-time</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="nx">addUser</span><span class="p">);</span>

<span class="nx">login</span><span class="p">();</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">#submit</span></code> button event listener gets the message text from the
input field, creates a new message on the messages service and then
clears out the field.</p></li>
<li><p>Next, we added two <code class="docutils literal notranslate"><span class="pre">created</span></code> event listeners. One for <code class="docutils literal notranslate"><span class="pre">messages</span></code>
which calls the <code class="docutils literal notranslate"><span class="pre">addMessage</span></code> function to add the new message to the
list and one for <code class="docutils literal notranslate"><span class="pre">users</span></code> which adds the user to the list via
<code class="docutils literal notranslate"><span class="pre">addUser</span></code>. This is how Feathers does real-time and everything we
need to do in order to get everything to update automatically.</p></li>
<li><p>To kick our application off, we call <code class="docutils literal notranslate"><span class="pre">login()</span></code> which as mentioned
above will either show the chat application right away (if we signed
in before and the token isn’t expired) or the login page.</p></li>
</ul>
</div>
<div class="section" id="whats-next">
<h2>What’s next?<a class="headerlink" href="#whats-next" title="永久链接至标题">¶</a></h2>
<p>That’s it. We now have a plain JavaScript real-time chat frontend with
login and signup. This example demonstrates many of the core principles
of how you interact with a Feathers API.</p>
<p>If you run into an issue, remember you can find a complete working
example <a class="reference external" href="https://github.com/feathersjs/feathers-chat">here</a>.</p>
<p>In the final chapter, we’ll look at <a class="reference internal" href="testing.html"><span class="doc">how to write automated tests for our API</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="写测试" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="processing.html" class="btn btn-neutral float-left" title="处理数据" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>