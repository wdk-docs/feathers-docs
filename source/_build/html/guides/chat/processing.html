

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>处理数据 &mdash; feathers docs v2019.06.21 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="建立一个前端" href="frontend.html" />
    <link rel="prev" title="添加身份验证" href="authentication.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> feathers docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Feathers</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../readme.html">指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/index.html">Feathers 基础功能</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">创建聊天应用程序</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="readme.html">创建聊天应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="creating.html">创建应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html">创建服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="authentication.html">添加身份验证</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">处理数据</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sanitize-new-message">Sanitize new message</a></li>
<li class="toctree-l4"><a class="reference internal" href="#add-a-user-avatar">Add a user avatar</a></li>
<li class="toctree-l4"><a class="reference internal" href="#populate-the-message-sender">Populate the message sender</a></li>
<li class="toctree-l4"><a class="reference internal" href="#whats-next">What’s next?</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="frontend.html">建立一个前端</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">写测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../auth/index.html">身份验证指南和食谱</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/index.html">高级指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frameworks/readme.html">与前端框架集成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrating.html">Feathers v3（秃鹰）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SECURITY.html">Feathers 安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Ecosystem/index.html">生态系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help/readme.html">救命！</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/readme.html">常问问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/readme.html">特约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">有许可证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../.github/index.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Summary.html">摘要</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">feathers docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">指南</a> &raquo;</li>
        
          <li><a href="index.html">创建聊天应用程序</a> &raquo;</li>
        
      <li>处理数据</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/guides/chat/processing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="processing-data">
<h1>处理数据<a class="headerlink" href="#processing-data" title="永久链接至标题">¶</a></h1>
<p>Now that we can <a class="reference internal" href="authentication.html"><span class="doc">添加身份验证</span></a>,
we are going to process data, sanitize the input we get from the client
and add extra information. For this chapter we require an empty database
which can be done by removing the <code class="docutils literal notranslate"><span class="pre">data/</span></code> folder (<code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">data/</span></code>).</p>
<div class="section" id="sanitize-new-message">
<h2>Sanitize new message<a class="headerlink" href="#sanitize-new-message" title="永久链接至标题">¶</a></h2>
<p>When creating a new message, we automatically sanitize our input, add
the user that sent it and include the date the message has been created,
before saving it in the database. This is where
<span class="xref std std-doc">basics/hooks</span> come into play. In this specific case, a
<em>before</em> hook. To create a new hook we can run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feathers</span> <span class="n">generate</span> <span class="n">hook</span>
</pre></div>
</div>
<p>Let’s call this hook <code class="docutils literal notranslate"><span class="pre">process-message</span></code>. We want to pre-process
client-provided data. Therefore, in the next prompt asking for what kind
of hook, choose <code class="docutils literal notranslate"><span class="pre">before</span></code> and press Enter.</p>
<p>Next a list of all our services is displayed. For this hook, only choose
the <code class="docutils literal notranslate"><span class="pre">messages</span></code> service. Navigate to the entry with the arrow keys and
select it with the space key.</p>
<p>A hook can run before any number of <a class="reference internal" href="../../api/services.html"><span class="doc">service methods</span></a>.
For this specific hook, only select <code class="docutils literal notranslate"><span class="pre">create</span></code>. After confirming the last prompt you should see something
like this:</p>
<div class="figure align-default" id="id1">
<img alt="The process-message hook prompts" src="../../_images/process-message.png" />
<p class="caption"><span class="caption-text">The process-message hook prompts</span><a class="headerlink" href="#id1" title="永久链接至图片">¶</a></p>
</div>
<p>A hook was generated and wired up to the selected service. Now it’s time
to add some code. Update <code class="docutils literal notranslate"><span class="pre">src/hooks/process-message.js</span></code> to look like
this:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Use this hook to manipulate incoming or outgoing data.</span>
<span class="c1">// For more information on hooks see: http://docs.feathersjs.com/api/hooks.html</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span> <span class="c1">// eslint-disable-line no-unused-vars</span>
  <span class="k">return</span> <span class="nx">async</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">data</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>

    <span class="c1">// Throw an error if we didn&#39;t get a text</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;A message must have a text&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// The authenticated user</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
    <span class="c1">// The actual message text</span>
    <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span>
      <span class="c1">// Messages can&#39;t be longer than 400 characters</span>
      <span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

    <span class="c1">// Override the original data (so that people can&#39;t submit additional stuff)</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">text</span><span class="p">,</span>
      <span class="c1">// Set the user id</span>
      <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
      <span class="c1">// Add the current date</span>
      <span class="nx">createdAt</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
    <span class="p">};</span>

    <span class="c1">// Best practice: hooks should always return the context</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This validation code includes:</p>
<ol class="arabic simple">
<li><p>Check if there is a <code class="docutils literal notranslate"><span class="pre">text</span></code> in the data and throw an error if not</p></li>
<li><p>Truncate the message’s <code class="docutils literal notranslate"><span class="pre">text</span></code> property to 400 characters</p></li>
<li><p>Update the data submitted to the database to contain:</p></li>
</ol>
<ul class="simple">
<li><p>The new truncated text</p></li>
<li><p>The currently authenticated user (so we always know who sent it)</p></li>
<li><p>The current (creation) date</p></li>
</ul>
</div>
<div class="section" id="add-a-user-avatar">
<h2>Add a user avatar<a class="headerlink" href="#add-a-user-avatar" title="永久链接至标题">¶</a></h2>
<p>Let’s generate another hook to add a link to the
<a class="reference external" href="http://en.gravatar.com/">Gravatar</a> image associated with the user’s
email address, so we can display an avatar. Run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">feathers</span> <span class="n">generate</span> <span class="n">hook</span>
</pre></div>
</div>
<p>The selections are almost the same as our previous hook:</p>
<ul class="simple">
<li><p>Call the hook <code class="docutils literal notranslate"><span class="pre">gravatar</span></code></p></li>
<li><p>It’s a <code class="docutils literal notranslate"><span class="pre">before</span></code> hook</p></li>
<li><p>… on the <code class="docutils literal notranslate"><span class="pre">users</span></code> service</p></li>
<li><p>… for the <code class="docutils literal notranslate"><span class="pre">create</span></code> method</p></li>
</ul>
<div class="figure align-default" id="id2">
<img alt="The gravatar hook prompts" src="../../_images/gravatar.png" />
<p class="caption"><span class="caption-text">The gravatar hook prompts</span><a class="headerlink" href="#id2" title="永久链接至图片">¶</a></p>
</div>
<p>Then we update <code class="docutils literal notranslate"><span class="pre">src/hooks/gravatar.js</span></code> with the following code:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Use this hook to manipulate incoming or outgoing data.</span>
<span class="c1">// For more information on hooks, see: http://docs.feathersjs.com/api/hooks.html</span>

<span class="c1">// We need this to create the MD5 hash</span>
<span class="kr">const</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>

<span class="c1">// The Gravatar image service</span>
<span class="kr">const</span> <span class="nx">gravatarUrl</span> <span class="o">=</span> <span class="s1">&#39;https://s.gravatar.com/avatar&#39;</span><span class="p">;</span>
<span class="c1">// The size query. Our chat needs 60px images</span>
<span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="s1">&#39;s=60&#39;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span> <span class="c1">// eslint-disable-line no-unused-vars</span>
  <span class="k">return</span> <span class="nx">async</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// The user email</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
    <span class="c1">// Gravatar uses MD5 hashes from an email address (all lowercase) to get the image</span>
    <span class="kr">const</span> <span class="nx">hash</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHash</span><span class="p">(</span><span class="s1">&#39;md5&#39;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">email</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()).</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span>

    <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">avatar</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">gravatarUrl</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">hash</span><span class="si">}</span><span class="sb">?</span><span class="si">${</span><span class="nx">query</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

    <span class="c1">// Best practice: hooks should always return the context</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Here we use <a class="reference external" href="https://nodejs.org/api/crypto.html">Node’s crypto
library</a> to create an MD5 hash of
the user’s email address. This is what Gravatar uses as the URL for the
avatar associated with an email address. When a new user is created,
this gravatar hook will set the <code class="docutils literal notranslate"><span class="pre">avatar</span></code> property to the avatar image
link.</p>
</div>
<div class="section" id="populate-the-message-sender">
<h2>Populate the message sender<a class="headerlink" href="#populate-the-message-sender" title="永久链接至标题">¶</a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">process-message</span></code> hook we are currently just adding the user’s
<code class="docutils literal notranslate"><span class="pre">_id</span></code> as the <code class="docutils literal notranslate"><span class="pre">userId</span></code> property in the message. We want to show more
than the <code class="docutils literal notranslate"><span class="pre">_id</span></code> in the UI, so we’ll need to populate more data in the
message response. To display a users’ details, we need to include extra
information in our messages.</p>
<p>We therefore create another hook:</p>
<ul class="simple">
<li><p>Call the hook <code class="docutils literal notranslate"><span class="pre">populate-user</span></code></p></li>
<li><p>It’s an <code class="docutils literal notranslate"><span class="pre">after</span></code> hook</p></li>
<li><p>… on the <code class="docutils literal notranslate"><span class="pre">messages</span></code> service</p></li>
<li><p>… for <code class="docutils literal notranslate"><span class="pre">all</span></code> methods</p></li>
</ul>
<div class="figure align-default" id="id3">
<img alt="The populate-user hook" src="../../_images/populate-user.png" />
<p class="caption"><span class="caption-text">The populate-user hook</span><a class="headerlink" href="#id3" title="永久链接至图片">¶</a></p>
</div>
<p>Once created, update <code class="docutils literal notranslate"><span class="pre">src/hooks/populate-user.js</span></code> to:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Use this hook to manipulate incoming or outgoing data.</span>
<span class="c1">// For more information on hooks, see: http://docs.feathersjs.com/api/hooks.html</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span> <span class="c1">// eslint-disable-line no-unused-vars</span>
  <span class="k">return</span> <span class="nx">async</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Get `app`, `method`, `params` and `result` from the hook context</span>
    <span class="kr">const</span> <span class="p">{</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">params</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">context</span><span class="p">;</span>

    <span class="c1">// Make sure that we always have a list of messages either by wrapping</span>
    <span class="c1">// a single message into an array or by getting the `data` from the `find` method&#39;s result</span>
    <span class="kr">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;find&#39;</span> <span class="o">?</span> <span class="nx">result</span><span class="p">.</span><span class="nx">data</span> <span class="o">:</span> <span class="p">[</span> <span class="nx">result</span> <span class="p">];</span>

    <span class="c1">// Asynchronously get user object from each message&#39;s `userId`</span>
    <span class="c1">// and add it to the message</span>
    <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">messages</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">async</span> <span class="nx">message</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Also pass the original `params` to the service call</span>
      <span class="c1">// so that it has the same information available (e.g. who is requesting it)</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
    <span class="p">}));</span>

    <span class="c1">// Best practice: hooks should always return the context</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">Promise.all</span></code> ensures that all the calls run in parallel,
instead of sequentially.</p>
</div>
</div>
<div class="section" id="whats-next">
<h2>What’s next?<a class="headerlink" href="#whats-next" title="永久链接至标题">¶</a></h2>
<p>In this section, we added three hooks to pre- and post-process our
message and user data. We now have a complete API to send and retrieve
messages, including authentication.</p>
<p>Now we are ready to build a frontend <a class="reference internal" href="frontend.html"><span class="doc">using modern plain JavaScript</span></a>.</p>
<p>See the <span class="xref std std-doc">frameworks/readme</span> for more
resources on specific frameworks like React, React Native, Angular or
VueJS. You’ll find guides for creating a complete chat front-end with
signup, logging, user listing and messages. There are also links to
complete chat applications built with some popular front-end frameworks.</p>
<p>You can also browse the <span class="xref std std-doc">../api/readme</span> for details on
using Feathers and its database adaptors.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="frontend.html" class="btn btn-neutral float-right" title="建立一个前端" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="authentication.html" class="btn btn-neutral float-left" title="添加身份验证" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>