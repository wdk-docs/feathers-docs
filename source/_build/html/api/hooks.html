

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>钩 &mdash; feathers docs v2019.06.21 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="活动" href="events.html" />
    <link rel="prev" title="服务" href="services.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../contents.html" class="icon icon-home"> feathers docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Feathers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="readme.html">API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#core">Core</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="application.html">应用</a></li>
<li class="toctree-l3"><a class="reference internal" href="services.html">服务</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">钩</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#quick-example">Quick Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hook-functions">Hook functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Hook context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Hook flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Asynchronous hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#registering-hooks">Registering hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-hooks">Application hooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="events.html">活动</a></li>
<li class="toctree-l3"><a class="reference internal" href="channels.html">活动频道</a></li>
<li class="toctree-l3"><a class="reference internal" href="errors.html">错误</a></li>
<li class="toctree-l3"><a class="reference internal" href="configuration.html">配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#transports">Transports</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#client">Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#authentication">Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#database">Database</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../migrating.html">Feathers v3（秃鹰）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../SECURITY.html">Feathers 安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Ecosystem/index.html">生态系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../help/readme.html">救命！</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/readme.html">常问问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/readme.html">特约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">有许可证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../.github/index.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Summary.html">摘要</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../contents.html">feathers docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">API</a> &raquo;</li>
        
      <li>钩</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api/hooks.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="hooks">
<h1>钩<a class="headerlink" href="#hooks" title="永久链接至标题">¶</a></h1>
<p>Hooks are pluggable middleware functions that can be registered
<strong>before</strong>, <strong>after</strong> or on __error__s of a <a class="reference internal" href="services.html"><span class="doc">service method</span></a>. You can register a single hook function or
create a chain of them to create complex work-flows. Most of the time
multiple hooks are registered so the examples show the “hook chain”
array style registration.</p>
<p>A hook is <strong>transport independent</strong>, which means it does not matter if
it has been called through HTTP(S) (REST), Socket.io, Primus or any
other transport Feathers may support in the future. They are also
service agnostic, meaning they can be used with ​<strong>any</strong>​ service
regardless of whether they have a model or not.</p>
<p>Hooks are commonly used to handle things like validation, logging,
populating related entities, sending notifications and more. This
pattern keeps your application logic flexible, composable, and much
easier to trace through and debug. For more information about the design
patterns behind hooks see <a class="reference external" href="https://blog.feathersjs.com/api-service-composition-with-hooks-47af13aa6c01">this blog post</a>.</p>
<div class="section" id="quick-example">
<h2>Quick Example<a class="headerlink" href="#quick-example" title="永久链接至标题">¶</a></h2>
<p>The following example adds a <code class="docutils literal notranslate"><span class="pre">createdAt</span></code> and <code class="docutils literal notranslate"><span class="pre">updatedAt</span></code> property
before saving the data to the database and logs any errors on the
service:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">feathers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/feathers&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">feathers</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">update</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">patch</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nx">error</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error in </span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb"> calling </span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">method</span><span class="si">}</span><span class="sb"> method`</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="hook-functions">
<h2>Hook functions<a class="headerlink" href="#hook-functions" title="永久链接至标题">¶</a></h2>
<p>A hook function can be a normal or <code class="docutils literal notranslate"><span class="pre">async</span></code> function or arrow function
that takes the <a class="reference external" href="#hook-context">hook context</a> as the parameter and can</p>
<ul class="simple">
<li><p>return a <code class="docutils literal notranslate"><span class="pre">context</span></code> object</p></li>
<li><p>return nothing (<code class="docutils literal notranslate"><span class="pre">undefined</span></code>)</p></li>
<li><p>return <code class="docutils literal notranslate"><span class="pre">feathers.SKIP</span></code> to skip all further hooks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">throw</span></code> an error</p></li>
<li><p>for asynchronous operations return a
<a class="reference external" href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a>
that</p>
<ul>
<li><p>resolves with a <code class="docutils literal notranslate"><span class="pre">context</span></code> object</p></li>
<li><p>resolves with <code class="docutils literal notranslate"><span class="pre">undefined</span></code></p></li>
<li><p>rejects with an error</p></li>
</ul>
</li>
</ul>
<p>For more information see the <a class="reference external" href="#hook-flow">hook flow</a> and
<a class="reference external" href="#asynchronous-hooks">asynchronous hooks</a> section.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// normal hook function</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// asynchronous hook function with promise</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// async hook function</span>
<span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// normal arrow function</span>
<span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// asynchronous arrow function with promise</span>
<span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// async arrow function</span>
<span class="nx">async</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// skip further hooks</span>
<span class="kr">const</span> <span class="nx">feathers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/feathers&#39;</span><span class="p">);</span>

<span class="nx">async</span> <span class="nx">context</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">feathers</span><span class="p">.</span><span class="nx">SKIP</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Hook context<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>The hook <code class="docutils literal notranslate"><span class="pre">context</span></code> is passed to a hook function and contains
information about the service method call. It has <strong>read only</strong>
properties that should not be modified and <strong>writeable</strong> properties that
can be changed for subsequent hooks.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>The <code class="docutils literal notranslate"><span class="pre">context</span></code> object is the same throughout a service
method call so it is possible to add properties and use them in other
hooks at a later time.</p>
</div>
<div class="section" id="context-app">
<h3>context.app<a class="headerlink" href="#context-app" title="永久链接至标题">¶</a></h3>
<p>:doc:<code class="docutils literal notranslate"><span class="pre">context.app</span></code> is a <em>read only</em> property that contains the <cite>Feathers application object &lt;./application&gt;</cite>. This can be used to retrieve
other services (via <code class="docutils literal notranslate"><span class="pre">context.app.service('name')</span></code>) or configuration
values.</p>
</div>
<div class="section" id="context-service">
<h3>context.service<a class="headerlink" href="#context-service" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.service</span></code> is a <em>read only</em> property and contains the service
this hook currently runs on.</p>
</div>
<div class="section" id="context-path">
<h3>context.path<a class="headerlink" href="#context-path" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.path</span></code> is a <em>read only</em> property and contains the service name
(or path) without leading or trailing slashes.</p>
</div>
<div class="section" id="context-method">
<h3>context.method<a class="headerlink" href="#context-method" title="永久链接至标题">¶</a></h3>
<p><a class="reference internal" href="services.html"><span class="doc">服务</span></a> (one of <code class="docutils literal notranslate"><span class="pre">find</span></code>, <code class="docutils literal notranslate"><span class="pre">get</span></code>, <code class="docutils literal notranslate"><span class="pre">create</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code>, <code class="docutils literal notranslate"><span class="pre">patch</span></code>, <code class="docutils literal notranslate"><span class="pre">remove</span></code>).</p>
</div>
<div class="section" id="context-type">
<h3>context.type<a class="headerlink" href="#context-type" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.type</span></code> is a <em>read only</em> property with the hook type (one of
<code class="docutils literal notranslate"><span class="pre">before</span></code>, <code class="docutils literal notranslate"><span class="pre">after</span></code> or <code class="docutils literal notranslate"><span class="pre">error</span></code>).</p>
</div>
<div class="section" id="context-params">
<h3>context.params<a class="headerlink" href="#context-params" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.params</span></code> is a <strong>writeable</strong> property that contains the
<a class="reference internal" href="services.html"><span class="doc">服务</span></a> parameters (including
:doc:<code class="docutils literal notranslate"><span class="pre">params.query</span></code>). For more information see the <cite>service params documentation &lt;./services#params&gt;</cite>.</p>
</div>
<div class="section" id="context-id">
<h3>context.id<a class="headerlink" href="#context-id" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.id</span></code> is a <strong>writeable</strong> property and the <code class="docutils literal notranslate"><span class="pre">id</span></code> for a <code class="docutils literal notranslate"><span class="pre">get</span></code>,
<code class="docutils literal notranslate"><span class="pre">remove</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">patch</span></code> service method call. For
<code class="docutils literal notranslate"><span class="pre">remove</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">patch</span></code> <code class="docutils literal notranslate"><span class="pre">context.id</span></code> can also be <code class="docutils literal notranslate"><span class="pre">null</span></code>
when modifying multiple entries. In all other cases it will be
<code class="docutils literal notranslate"><span class="pre">undefined</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">context.id</span></code> is only available for method types <code class="docutils literal notranslate"><span class="pre">get</span></code>,
<code class="docutils literal notranslate"><span class="pre">remove</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">patch</span></code>.</p>
</div>
</div>
<div class="section" id="context-data">
<h3>context.data<a class="headerlink" href="#context-data" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.data</span></code> is a <strong>writeable</strong> property containing the data of a
<code class="docutils literal notranslate"><span class="pre">create</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">patch</span></code> service method call.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">context.data</span></code> will only be available for method types
<code class="docutils literal notranslate"><span class="pre">create</span></code>, <code class="docutils literal notranslate"><span class="pre">update</span></code> and <code class="docutils literal notranslate"><span class="pre">patch</span></code>.</p>
</div>
</div>
<div class="section" id="context-error">
<h3>context.error<a class="headerlink" href="#context-error" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.error</span></code> is a <strong>writeable</strong> property with the error object that
was thrown in a failed method call. It is only available in <code class="docutils literal notranslate"><span class="pre">error</span></code>
hooks.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">context.error</span></code> will only be available if
<code class="docutils literal notranslate"><span class="pre">context.type</span></code> is <code class="docutils literal notranslate"><span class="pre">error</span></code>.</p>
</div>
</div>
<div class="section" id="context-result">
<h3>context.result<a class="headerlink" href="#context-result" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.result</span></code> is a <strong>writeable</strong> property containing the result of
the successful service method call. It is only available in <code class="docutils literal notranslate"><span class="pre">after</span></code>
hooks. <code class="docutils literal notranslate"><span class="pre">context.result</span></code> can also be set in</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">before</span></code> hook to skip the actual service method (database) call</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">error</span></code> hook to swallow the error and return a result instead</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">context.result</span></code> will only be available if
<code class="docutils literal notranslate"><span class="pre">context.type</span></code> is <code class="docutils literal notranslate"><span class="pre">after</span></code> or if <code class="docutils literal notranslate"><span class="pre">context.result</span></code> has been set.</p>
</div>
</div>
<div class="section" id="context-dispatch">
<h3>context.dispatch<a class="headerlink" href="#context-dispatch" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code> is a <strong>writeable, optional</strong> property and contains
a “safe” version of the data that should be sent to any client. If
<code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code> has not been set <code class="docutils literal notranslate"><span class="pre">context.result</span></code> will be sent to
the client instead.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p><code class="docutils literal notranslate"><span class="pre">context.dispatch</span></code> only affects the data sent through a
Feathers Transport like <a class="reference external" href="./express">REST</a> or
<a class="reference internal" href="socketio.html"><span class="doc">Socket.io</span></a>. An internal method call will still get
the data set in <code class="docutils literal notranslate"><span class="pre">context.result</span></code>.</p>
</div>
</div>
<div class="section" id="context-statuscode">
<h3>context.statusCode<a class="headerlink" href="#context-statuscode" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context.statusCode</span></code> is a <strong>writeable, optional</strong> property that allows
to override the standard <a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">HTTP status
code</a> that
should be returned.</p>
</div>
</div>
<div class="section" id="id2">
<h2>Hook flow<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>In general, hooks are executed in the order they are registered with the
original service method being called after all <code class="docutils literal notranslate"><span class="pre">before</span></code> hooks. This
flow can be affected as follows.</p>
<div class="section" id="throwing-an-error">
<h3>Throwing an error<a class="headerlink" href="#throwing-an-error" title="永久链接至标题">¶</a></h3>
<p>When an error is thrown (or the promise is rejected), all subsequent
hooks - and the service method call if it didn’t run already - will be
skipped and only the error hooks will run.</p>
<p>The following example throws an error when the text for creating a new
message is empty. You can also create very similar hooks to use your
Node validation library of choice.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Message text can not be empty&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="setting-context-result">
<h3>Setting <code class="docutils literal notranslate"><span class="pre">context.result</span></code><a class="headerlink" href="#setting-context-result" title="永久链接至标题">¶</a></h3>
<p>When <code class="docutils literal notranslate"><span class="pre">context.result</span></code> is set in a <code class="docutils literal notranslate"><span class="pre">before</span></code> hook, the original
<a class="reference internal" href="services.html"><span class="doc">服务</span></a> call will be skipped. All other hooks
will still execute in their normal order. The following example always
returns the currently <a class="reference external" href="./authentication/server.md">authenticated
user</a> instead of the actual user for all
<code class="docutils literal notranslate"><span class="pre">get</span></code> method calls:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Never call the actual users service</span>
        <span class="c1">// just use the authenticated user</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">user</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="returning-feathers-skip">
<h3>Returning <code class="docutils literal notranslate"><span class="pre">feathers.SKIP</span></code><a class="headerlink" href="#returning-feathers-skip" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">require('&#64;feathersjs/feathers').SKIP</span></code> can be returned from a hook to
indicate that all following hooks should be skipped. If returned by a
<strong>before</strong> hook, the remaining <strong>before</strong> hooks are skipped; any
<strong>after</strong> hooks will still be run. If it hasn’t run yet, the service
method will still be called unless <code class="docutils literal notranslate"><span class="pre">context.result</span></code> is set already.</p>
</div>
</div>
<div class="section" id="id3">
<h2>Asynchronous hooks<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>When the hook function is <code class="docutils literal notranslate"><span class="pre">async</span></code> or a Promise is returned it will
wait until all asynchronous operations resolve or reject before
continuing to the next hook.</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>As stated in the <a class="reference external" href="#hook-functions">hook functions</a>
section the promise has to either resolve with the <code class="docutils literal notranslate"><span class="pre">context</span></code> object
(usually done with <code class="docutils literal notranslate"><span class="pre">.then(()</span> <span class="pre">=&gt;</span> <span class="pre">context)</span></code> at the end of the promise
chain) or with <code class="docutils literal notranslate"><span class="pre">undefined</span></code>.</p>
</div>
<div class="section" id="async-await">
<h3>async/await<a class="headerlink" href="#async-await" title="永久链接至标题">¶</a></h3>
<p>When using Node v8.0.0 or later the use of
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">async/await</a>
is highly recommended. This will avoid many common issues when using
Promises and asynchronous hook flows. Any hook function can be <code class="docutils literal notranslate"><span class="pre">async</span></code>
in which case it will wait until all <code class="docutils literal notranslate"><span class="pre">await</span></code> operations are completed.
Just like a normal hook it should return the <code class="docutils literal notranslate"><span class="pre">context</span></code> object or
<code class="docutils literal notranslate"><span class="pre">undefined</span></code>.</p>
<p>The following example shows an async/await hook that uses another
service to retrieve and populate the messages <code class="docutils literal notranslate"><span class="pre">user</span></code> when getting a
single message:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
      <span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>

        <span class="c1">// Since context.app.service(&#39;users&#39;).get returns a promise we can `await` it</span>
        <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>

        <span class="c1">// Update the result (the message)</span>
        <span class="nx">context</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>

        <span class="c1">// Returning will resolve the promise with the `context` object</span>
        <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="returning-promises">
<h3>Returning promises<a class="headerlink" href="#returning-promises" title="永久链接至标题">¶</a></h3>
<p>The following example shows an asynchronous hook that uses another
service to retrieve and populate the messages <code class="docutils literal notranslate"><span class="pre">user</span></code> when getting a
single message.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">userId</span><span class="p">;</span>

        <span class="c1">// context.app.service(&#39;users&#39;).get returns a Promise already</span>
        <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">user</span> <span class="p">=&gt;</span> <span class="p">{</span>
          <span class="c1">// Update the result (the message)</span>
          <span class="nx">context</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>

          <span class="c1">// Returning will resolve the promise with the `context` object</span>
          <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>A common issue when hooks are not running in the expected
order is a missing <code class="docutils literal notranslate"><span class="pre">return</span></code> statement of a promise at the top level
of the hook function.</p>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>Most Feathers service calls and newer Node packages
already return Promises. They can be returned and chained directly.
There is no need to instantiate your own <code class="docutils literal notranslate"><span class="pre">new</span></code> Promise instance in
those cases.</p>
</div>
</div>
<div class="section" id="converting-callbacks">
<h3>Converting callbacks<a class="headerlink" href="#converting-callbacks" title="永久链接至标题">¶</a></h3>
<p>When the asynchronous operation is using a <em>callback</em> instead of
returning a promise you have to create and return a new Promise
(<code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Promise((resolve,</span> <span class="pre">reject)</span> <span class="pre">=&gt;</span> <span class="pre">{})</span></code>) or use
<a class="reference external" href="https://nodejs.org/api/util.html#util_util_promisify_original">util.promisify</a>.</p>
<p>The following example reads a JSON file converting
<a class="reference external" href="https://nodejs.org/api/fs.html#fs_fs_readfile_file_options_callback">fs.readFile</a>
with <code class="docutils literal notranslate"><span class="pre">util.promisify</span></code>:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">promisify</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./myfile.json&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="p">=&gt;</span> <span class="p">{</span>
          <span class="nx">context</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">myFile</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>

          <span class="k">return</span> <span class="nx">context</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>Other tools like
<a class="reference external" href="https://github.com/petkaantonov/bluebird">Bluebird</a> also help
converting between callbacks and promises.</p>
</div>
</div>
</div>
<div class="section" id="registering-hooks">
<h2>Registering hooks<a class="headerlink" href="#registering-hooks" title="永久链接至标题">¶</a></h2>
<p>Hook functions are registered on a service through the
<code class="docutils literal notranslate"><span class="pre">app.service(&lt;servicename&gt;).hooks(hooks)</span></code> method. There are several
options for what can be passed as <code class="docutils literal notranslate"><span class="pre">hooks</span></code>:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// The standard all at once way (also used by the generator)</span>
<span class="c1">// an array of functions per service method name (and for `all` methods)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;servicename&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[</span>
      <span class="c1">// Use normal functions</span>
      <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before all hook ran&#39;</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">],</span>
    <span class="nx">find</span><span class="o">:</span> <span class="p">[</span>
      <span class="c1">// Use ES6 arrow functions</span>
      <span class="nx">context</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before find hook 1 ran&#39;</span><span class="p">),</span>
      <span class="nx">context</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before find hook 2 ran&#39;</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[</span> <span class="cm">/* other hook functions here */</span> <span class="p">],</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">update</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">patch</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="p">[]</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">find</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">update</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">patch</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="p">[]</span>
  <span class="p">},</span>
  <span class="nx">error</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">all</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">find</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">get</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">create</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">update</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">patch</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">remove</span><span class="o">:</span> <span class="p">[]</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Register a single hook before, after and on error for all methods</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;servicename&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">before</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;before all hook ran&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">after</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;after all hook ran&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">error</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error all hook ran&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>When using the full object, <code class="docutils literal notranslate"><span class="pre">all</span></code> is a special keyword
meaning this hook will run for all methods. <code class="docutils literal notranslate"><span class="pre">all</span></code> hooks will be
registered before other method specific hooks.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p><code class="docutils literal notranslate"><span class="pre">app.service(&lt;servicename&gt;).hooks(hooks)</span></code> can be
called multiple times and the hooks will be registered in that order.
Normally all hooks should be registered at once however to see at a
glance what the service is going to do.</p>
</div>
</div>
<div class="section" id="application-hooks">
<h2>Application hooks<a class="headerlink" href="#application-hooks" title="永久链接至标题">¶</a></h2>
<p>To add hooks to every service <code class="docutils literal notranslate"><span class="pre">app.hooks(hooks)</span></code> can be used.
Application hooks are <a class="reference external" href="#registering-hooks">registered in the same format as service
hooks</a> and also work exactly the same. Note when
application hooks will be executed however:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">before</span></code> application hooks will always run <em>before</em> all service
<code class="docutils literal notranslate"><span class="pre">before</span></code> hooks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">after</span></code> application hooks will always run <em>after</em> all service
<code class="docutils literal notranslate"><span class="pre">after</span></code> hooks</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">error</span></code> application hooks will always run <em>after</em> all service
<code class="docutils literal notranslate"><span class="pre">error</span></code> hooks</p></li>
</ul>
<p>Here is an example for a very useful application hook that logs every
service method error with the service and method name as well as the
error stack.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">app</span><span class="p">.</span><span class="nx">hooks</span><span class="p">({</span>
  <span class="nx">error</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error in &#39;</span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">&#39; service method &#39;</span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">method</span><span class="si">}</span><span class="sb">&#39;`</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="events.html" class="btn btn-neutral float-right" title="活动" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="services.html" class="btn btn-neutral float-left" title="服务" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>