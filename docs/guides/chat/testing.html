

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>写测试 &mdash; feathers docs v2019.06.21 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="身份验证指南和食谱" href="../auth/index.html" />
    <link rel="prev" title="建立一个前端" href="frontend.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> feathers docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Feathers[fɛðɚ]</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../readme.html">指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/index.html">Feathers 基础功能</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">创建聊天应用程序</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="readme.html">创建聊天应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="creating.html">创建应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html">创建服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="authentication.html">添加身份验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="processing.html">处理数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="frontend.html">建立一个前端</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">写测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#unit-testing-hooks">单元测试挂钩</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-database-setup">测试数据库设置</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-services">测试服务</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client-server-testing">Client/server 测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-coverage">代码覆盖率</a></li>
<li class="toctree-l4"><a class="reference internal" href="#changing-the-default-test-directory">更改默认测试目录</a></li>
<li class="toctree-l4"><a class="reference internal" href="#whats-next">下一步是什么？</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../auth/index.html">身份验证指南和食谱</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/index.html">高级指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frameworks/readme.html">与前端框架集成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrating.html">Feathers v3(秃鹰)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SECURITY.html">Feathers 安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Ecosystem/index.html">令人敬畏的Feathers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help/readme.html">求助！</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/readme.html">常问问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/readme.html">特约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">有许可证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../github/index.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Summary.html">摘要</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">feathers docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">指南</a> &raquo;</li>
        
          <li><a href="index.html">创建聊天应用程序</a> &raquo;</li>
        
      <li>写测试</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/guides/chat/testing.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-tests">
<h1>写测试<a class="headerlink" href="#writing-tests" title="永久链接至标题">¶</a></h1>
<p>每当我们生成一个钩子或服务时, 生成器也会设置一个基本的 <a class="reference external" href="https://mochajs.org/">Mocha</a> test, 我们可以使用它来为它实现单元测试. 在本章中, 我们将为我们的 <a class="reference internal" href="processing.html"><span class="doc">处理数据</span></a> 和 <a class="reference internal" href="service.html"><span class="doc">创建服务</span></a> 的集成测试实现单元测试.</p>
<p>我们可以运行 <a class="reference external" href="https://eslint.org/">code Linter</a> 和Mocha测试</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm <span class="nb">test</span>
</pre></div>
</div>
<p>这将最初失败, 因为我们在钩子中实现了标准测试未涵盖的功能. 所以让我们先通过.</p>
<div class="section" id="unit-testing-hooks">
<h2>单元测试挂钩<a class="headerlink" href="#unit-testing-hooks" title="永久链接至标题">¶</a></h2>
<p>测试单个钩子的最好方法是设置一个虚拟Feathers应用程序, 其中包含一些返回我们期望的数据并可以测试的服务, 然后注册钩子并进行实际的服务调用以验证它们返回我们期望的内容.</p>
<p>我们创建的第一个钩子是用于处理新消息. 对于这个钩子, 我们可以创建一个 <code class="docutils literal notranslate"><span class="pre">messages</span></code> 虚拟自定义 <a class="reference internal" href="../basics/services.html"><span class="doc">服务</span></a>, 只返回来自 <code class="docutils literal notranslate"><span class="pre">create</span></code> 服务方法的相同数据. 假装我们是经过身份验证的用户, 我们必须通过 <code class="docutils literal notranslate"><span class="pre">params.user</span></code>. 对于此测试, 这可以是一个带有 <code class="docutils literal notranslate"><span class="pre">_id</span></code> 的简单JavaScript对象.</p>
<p>将 <code class="docutils literal notranslate"><span class="pre">test/hooks/process-messages.test.js</span></code> 更新为以下内容:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">feathers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/feathers&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">processMessage</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/hooks/process-message&#39;</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;process-message\&#39; hook&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">app</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Create a new plain Feathers application</span>
    <span class="nx">app</span> <span class="o">=</span> <span class="nx">feathers</span><span class="p">();</span>

    <span class="c1">// Register a dummy custom service that just return the</span>
    <span class="c1">// message data back</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/messages&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// Register the `processMessage` hook on that service</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
      <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">create</span><span class="o">:</span> <span class="nx">processMessage</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;processes the message as expected&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// A user stub with just an `_id`</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;test&#39;</span> <span class="p">};</span>
    <span class="c1">// The service method call `params`</span>
    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span> <span class="p">};</span>

    <span class="c1">// Create a new message with params that contains our user</span>
    <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Hi there&#39;</span><span class="p">,</span>
      <span class="nx">additional</span><span class="o">:</span> <span class="s1">&#39;should be removed&#39;</span>
    <span class="p">},</span> <span class="nx">params</span><span class="p">);</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="s1">&#39;Hi there&#39;</span><span class="p">);</span>
    <span class="c1">// `userId` was set</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">);</span>
    <span class="c1">// `additional` property has been removed</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">.</span><span class="nx">additional</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>我们可以采用类似的方法来测试 <code class="docutils literal notranslate"><span class="pre">test/hooks/gravatar.test.js</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">gravatar</span></code> 钩子. :</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">feathers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/feathers&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">gravatar</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/hooks/gravatar&#39;</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;gravatar\&#39; hook&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">app</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">app</span> <span class="o">=</span> <span class="nx">feathers</span><span class="p">();</span>

    <span class="c1">// A dummy users service for testing</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">async</span> <span class="nx">create</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// Add the hook to the dummy service</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
      <span class="nx">before</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">create</span><span class="o">:</span> <span class="nx">gravatar</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;creates a gravatar link from the users email&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;test@example.com&#39;</span>
    <span class="p">});</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
      <span class="nx">avatar</span><span class="o">:</span> <span class="s1">&#39;https://s.gravatar.com/avatar/55502f40dc8b7c769880b10874abc9d0?s=60&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>在上面的测试中, 我们创建了一个虚拟服务. 但有时, 我们需要完整的Feathers服务功能. <a class="reference external" href="https://github.com/feathersjs-ecosystem/feathers-memory">feathers-memory</a> 是一个有用的 <a class="reference internal" href="../basics/databases.html"><span class="doc">数据库</span></a>, 支持Feathers查询语法(和分页)但不支持需要数据库服务器. 我们可以将它安装为开发依赖项:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm install feathers-memory --save-dev
</pre></div>
</div>
<p>让我们用它来测试 <code class="docutils literal notranslate"><span class="pre">populateUser</span></code> 钩子, 将 <code class="docutils literal notranslate"><span class="pre">test/hooks/populate-user.test.js</span></code> 更新为:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">feathers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/feathers&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">memory</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;feathers-memory&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">populateUser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/hooks/populate-user&#39;</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;populate-user\&#39; hook&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">user</span><span class="p">;</span>

  <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Database adapter pagination options</span>
    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">paginate</span><span class="o">:</span> <span class="p">{</span>
        <span class="k">default</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="nx">max</span><span class="o">:</span> <span class="mi">25</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">app</span> <span class="o">=</span> <span class="nx">feathers</span><span class="p">();</span>

    <span class="c1">// Register `users` and `messages` service in-memory</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="nx">memory</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/messages&#39;</span><span class="p">,</span> <span class="nx">memory</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span>

    <span class="c1">// Add the hook to the dummy service</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">hooks</span><span class="p">({</span>
      <span class="nx">after</span><span class="o">:</span> <span class="nx">populateUser</span><span class="p">()</span>
    <span class="p">});</span>

    <span class="c1">// Create a new user we can use to test with</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;test@user.com&#39;</span>
    <span class="p">});</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;populates a new message with the user&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;A test message&#39;</span><span class="p">,</span>
      <span class="c1">// Set `userId` manually (usually done by `process-message` hook)</span>
      <span class="nx">userId</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">});</span>

    <span class="c1">// Make sure that user got added to the returned message</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>如果我们现在运行:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm <span class="nb">test</span>
</pre></div>
</div>
<p>我们所有的测试都应该通过好极了！</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>运行测试时会打印一些错误堆栈. 这是正常的, 它们是运行404(未找到)错误测试时的日志条目.</p>
</div>
</div>
<div class="section" id="test-database-setup">
<h2>测试数据库设置<a class="headerlink" href="#test-database-setup" title="永久链接至标题">¶</a></h2>
<p>在测试数据库功能时, 我们希望确保测试使用不同的数据库. 我们可以通过在 <code class="docutils literal notranslate"><span class="pre">config/test.json</span></code> 中创建一个具有以下内容的新环境配置来实现这一点:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;nedb&quot;</span><span class="o">:</span> <span class="s2">&quot;../test/data&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>当 <code class="docutils literal notranslate"><span class="pre">NODE_ENV</span></code> 设置为 <code class="docutils literal notranslate"><span class="pre">test</span></code> 时, 这将设置NeDB数据库使用 <code class="docutils literal notranslate"><span class="pre">test/data</span></code> 作为基目录而不是 <code class="docutils literal notranslate"><span class="pre">data/</span></code>. 对于其他数据库的连接字符串也可以完成同样的事情.</p>
<p>我们还希望确保在每次测试运行之前清理数据库. 为了在跨平台实现这一点, 首先运行:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm install shx --save-dev
</pre></div>
</div>
<p>现在我们可以将 <code class="docutils literal notranslate"><span class="pre">package.json</span></code> 的 <code class="docutils literal notranslate"><span class="pre">script</span></code> 部分更新为以下内容:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
  <span class="s2">&quot;test&quot;</span><span class="o">:</span> <span class="s2">&quot;npm run eslint &amp;&amp; npm run mocha&quot;</span><span class="p">,</span>
  <span class="s2">&quot;eslint&quot;</span><span class="o">:</span> <span class="s2">&quot;eslint src/. test/. --config .eslintrc.json&quot;</span><span class="p">,</span>
  <span class="s2">&quot;start&quot;</span><span class="o">:</span> <span class="s2">&quot;node src/&quot;</span><span class="p">,</span>
  <span class="s2">&quot;clean&quot;</span><span class="o">:</span> <span class="s2">&quot;shx rm -rf test/data/&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mocha&quot;</span><span class="o">:</span> <span class="s2">&quot;npm run clean &amp;&amp; NODE_ENV=test mocha test/ --recursive --exit&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在Windows上, <code class="docutils literal notranslate"><span class="pre">mocha</span></code> 应该是这样的:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm run clean <span class="p">&amp;</span> SET <span class="nv">NODE_ENV</span><span class="o">=</span>test<span class="p">&amp;</span> mocha test/ --recursive --exit
</pre></div>
</div>
<p>这将确保在每次测试运行之前删除 <code class="docutils literal notranslate"><span class="pre">test/data</span></code> 文件夹并正确设置 <code class="docutils literal notranslate"><span class="pre">NODE_ENV</span></code>.</p>
</div>
<div class="section" id="testing-services">
<h2>测试服务<a class="headerlink" href="#testing-services" title="永久链接至标题">¶</a></h2>
<p>为了测试实际的 <code class="docutils literal notranslate"><span class="pre">messages</span></code> 和 <code class="docutils literal notranslate"><span class="pre">users</span></code> 服务(所有挂钩连线), 我们可以使用任何REST API测试工具发出请求并验证它们是否返回正确的响应.</p>
<p>但是有一种更快, 更简单和完整的方法. 由于Feathers已经提供(和测试)了我们自己的钩子和服务之上的所有东西, 我们可以直接要求 <a class="reference internal" href="../../api/services.html"><span class="doc">服务</span></a>, 并通过设置 <code class="docutils literal notranslate"><span class="pre">params.user</span></code> 来 “fake” 认证 如上面的钩子测试中所示.</p>
<p>默认情况下, 生成器创建服务测试文件, 例如,  <code class="docutils literal notranslate"><span class="pre">test/services/users.test.js</span></code>, 只测试服务是否存在, 如下所示:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/app&#39;</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;users\&#39; service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;registered the service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span> <span class="s1">&#39;Registered the service&#39;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>然后我们可以添加使用该服务的类似测试. 以下是一个更新的 <code class="docutils literal notranslate"><span class="pre">test/services/users.test.js</span></code>, 它增加了两个测试. 第一个验证是否可以创建用户, 设置gravatar并加密密码. 第二个验证密码未发送到外部请求:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/app&#39;</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;users\&#39; service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;registered the service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span> <span class="s1">&#39;Registered the service&#39;</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;creates a user, encrypts password and adds gravatar&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;test@example.com&#39;</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
    <span class="p">});</span>

    <span class="c1">// Verify Gravatar has been set as we&#39;d expect</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="p">,</span> <span class="s1">&#39;https://s.gravatar.com/avatar/55502f40dc8b7c769880b10874abc9d0?s=60&#39;</span><span class="p">);</span>
    <span class="c1">// Makes sure the password got encrypted</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">!==</span> <span class="s1">&#39;secret&#39;</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;removes password for external requests&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Setting `provider` indicates an external request</span>
    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">provider</span><span class="o">:</span> <span class="s1">&#39;rest&#39;</span> <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;test2@example.com&#39;</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
    <span class="p">},</span> <span class="nx">params</span><span class="p">);</span>

    <span class="c1">// Make sure password has been removed</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>我们对 <code class="docutils literal notranslate"><span class="pre">test/services/messages.test.js</span></code> 采取了类似的方法. 我们从 <code class="docutils literal notranslate"><span class="pre">users</span></code> 服务创建一个特定于测试的用户. 然后我们在创建新消息时将其作为 <code class="docutils literal notranslate"><span class="pre">params.user</span></code> 传递, 并验证该消息的内容:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/app&#39;</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;messages\&#39; service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;registered the service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">);</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span> <span class="s1">&#39;Registered the service&#39;</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;creates and processes message, adds user information&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Create a new user we can use for testing</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;messagetest@example.com&#39;</span><span class="p">,</span>
      <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;supersecret&#39;</span>
    <span class="p">});</span>

    <span class="c1">// The messages service call params (with the user we just created)</span>
    <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">user</span> <span class="p">};</span>
    <span class="kr">const</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;a test&#39;</span><span class="p">,</span>
      <span class="nx">additional</span><span class="o">:</span> <span class="s1">&#39;should be removed&#39;</span>
    <span class="p">},</span> <span class="nx">params</span><span class="p">);</span>

    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="s1">&#39;a test&#39;</span><span class="p">);</span>
    <span class="c1">// `userId` should be set to passed users it</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
    <span class="c1">// Additional property has been removed</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">message</span><span class="p">.</span><span class="nx">additional</span><span class="p">);</span>
    <span class="c1">// `user` has been populated</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">deepEqual</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>再次运行 <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">test</span></code>, 验证我们所有钩子的测试以及新的服务测试是否通过.</p>
</div>
<div class="section" id="client-server-testing">
<h2>Client/server 测试<a class="headerlink" href="#client-server-testing" title="永久链接至标题">¶</a></h2>
<p>您可以编写测试来启动应用程序的服务器, 以及测试可用于调用服务器的Feathers客户端. 此类测试可能会暴露客户端与服务器之间交互的错误. 它们还可用于测试来自客户端的请求的身份验证. 将其安装为开发依赖项:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm install @feathersjs/client --save-dev
</pre></div>
</div>
<p>从上面测试 <code class="docutils literal notranslate"><span class="pre">test/services/users.test.js</span></code> 在服务器上运行. 我们将其转换为以下 <code class="docutils literal notranslate"><span class="pre">tests/services/client-users.test.js</span></code>, 因此测试在客户端而不是服务器上运行. 这也会导致客户端身份验证被测试.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">feathersClient</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@feathersjs/client&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io-client&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../../src/app&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">email</span> <span class="o">=</span> <span class="s1">&#39;login@example.com&#39;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">password</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;\&#39;users\&#39; service - client&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">server</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">client</span><span class="p">;</span>

  <span class="nx">before</span><span class="p">(</span><span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">app</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span> <span class="p">});</span>

    <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;listening&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// eslint-disable-next-line no-console</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Feathers application started on http://%s:%d&#39;</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">client</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">makeClient</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">after</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">client</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
    <span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
  <span class="p">});</span>

  <span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;Run tests using client and server&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;registered the service&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">);</span>

      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">service</span><span class="p">,</span> <span class="s1">&#39;Registered the service&#39;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;creates a user, encrypts password and adds gravatar&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;testclient@example.com&#39;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
      <span class="p">});</span>

      <span class="c1">// Verify Gravatar has been set to what we&#39;d expect</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="p">,</span> <span class="s1">&#39;https://s.gravatar.com/avatar/1b9c869fa7a93e59463c31a377fe0cf6?s=60&#39;</span><span class="p">);</span>
      <span class="c1">// Makes sure the password got encrypted</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span> <span class="o">!==</span> <span class="s1">&#39;secret&#39;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;removes password for external requests&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Setting `provider` indicates an external request</span>
      <span class="kr">const</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">provider</span><span class="o">:</span> <span class="s1">&#39;rest&#39;</span> <span class="p">};</span>

      <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;testclient2@example.com&#39;</span><span class="p">,</span>
        <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;secret&#39;</span>
      <span class="p">},</span> <span class="nx">params</span><span class="p">);</span>

      <span class="c1">// Make sure password has been removed</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">ok</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">password</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">async</span> <span class="kd">function</span> <span class="nx">makeClient</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">feathersClient</span><span class="p">();</span>
  <span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="sb">`http://</span><span class="si">${</span><span class="nx">host</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;websocket&#39;</span><span class="p">],</span> <span class="nx">forceNew</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">reconnection</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">extraHeaders</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">});</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">feathersClient</span><span class="p">.</span><span class="nx">socketio</span><span class="p">(</span><span class="nx">socket</span><span class="p">));</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">feathersClient</span><span class="p">.</span><span class="nx">authentication</span><span class="p">({</span>
    <span class="nx">storage</span><span class="o">:</span> <span class="nx">localStorage</span><span class="p">()</span>
  <span class="p">}));</span>

  <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">({</span>
    <span class="nx">strategy</span><span class="o">:</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span>
    <span class="nx">email</span><span class="p">,</span>
    <span class="nx">password</span><span class="p">,</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">client</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">localStorage</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">setItem</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">store</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">getItem</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">store</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">},</span>
    <span class="nx">removeItem</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">delete</span> <span class="nx">store</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>我们首先在* server <a href="#id1"><span class="problematic" id="id2">*</span></a>上调用以创建新用户. 然后, 我们为我们的应用程序启动服务器. 最后调用函数 <code class="docutils literal notranslate"><span class="pre">makeClient</span></code> 来创建Feathers客户端并使用新创建的用户对其进行身份验证.</p>
<p>各个测试保持不变, 除了服务调用现在在客户端(<code class="docutils literal notranslate"><span class="pre">client.service(...).create</span></code>)而不是在服务器上进行(<code class="docutils literal notranslate"><span class="pre">app.service(...).create</span></code>).</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a>describe(‘使用客户端和服务器运行测试’, ‘<a href="#id3"><span class="problematic" id="id4">`</span></a>语句停止为每个测试创建一个新的服务器和客户端.这导致测试模块运行明显更快, 尽管测试现在暴露于潜在的迭代.您可以删除该语句以将测试彼此隔离.</p>
</div>
<div class="section" id="code-coverage">
<h2>代码覆盖率<a class="headerlink" href="#code-coverage" title="永久链接至标题">¶</a></h2>
<p>代码覆盖率是一种很好的方式, 可以了解我们在测试期间实际执行了多少代码. 使用 <a class="reference external" href="https://github.com/gotwarlost/istanbul">Istanbul</a> 我们可以轻松添加它:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm install nyc --save-dev
</pre></div>
</div>
<p>现在我们必须更新 <code class="docutils literal notranslate"><span class="pre">package.json</span></code> 的 <code class="docutils literal notranslate"><span class="pre">script</span></code> 部分:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">{</span>
  <span class="s2">&quot;test&quot;</span><span class="o">:</span> <span class="s2">&quot;npm run eslint &amp;&amp; npm run coverage&quot;</span><span class="p">,</span>
  <span class="s2">&quot;coverage&quot;</span><span class="o">:</span> <span class="s2">&quot;npm run clean &amp;&amp; NODE_ENV=test nyc mocha&quot;</span><span class="p">,</span>
  <span class="s2">&quot;eslint&quot;</span><span class="o">:</span> <span class="s2">&quot;eslint src/. test/. --config .eslintrc.json --fix&quot;</span><span class="p">,</span>
  <span class="s2">&quot;start&quot;</span><span class="o">:</span> <span class="s2">&quot;node src/&quot;</span><span class="p">,</span>
  <span class="s2">&quot;clean&quot;</span><span class="o">:</span> <span class="s2">&quot;shx rm -rf test/data/&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mocha&quot;</span><span class="o">:</span> <span class="s2">&quot;npm run clean &amp;&amp; NODE_ENV=test mocha test/ --recursive --exit&quot;</span>
<span class="p">},</span>
</pre></div>
</div>
<p>在Windows上, <code class="docutils literal notranslate"><span class="pre">coverage</span></code> 命令如下所示:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm run clean <span class="p">&amp;</span> SET <span class="nv">NODE_ENV</span><span class="o">=</span>test<span class="p">&amp;</span> nyc mocha
</pre></div>
</div>
<p>现在跑:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm <span class="nb">test</span>
</pre></div>
</div>
<p>这将打印出一些额外的覆盖信息.</p>
</div>
<div class="section" id="changing-the-default-test-directory">
<h2>更改默认测试目录<a class="headerlink" href="#changing-the-default-test-directory" title="永久链接至标题">¶</a></h2>
<p>要更改默认测试目录, 请在项目的 <code class="docutils literal notranslate"><span class="pre">package.json</span></code> 文件中指定所需的目录:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;directories&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;server/test/&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>另外, 不要忘记更新 <code class="docutils literal notranslate"><span class="pre">package.json</span></code> 文件中的mocha脚本:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span>&quot;scripts&quot;: {
  &quot;mocha&quot;: &quot;mocha server/test/ --recursive --exit&quot;
}
</pre></div>
</div>
</div>
<div class="section" id="whats-next">
<h2>下一步是什么？<a class="headerlink" href="#whats-next" title="永久链接至标题">¶</a></h2>
<p>就是这样 - 我们的聊天指南已经完成！我们现在有一个经过全面测试的REST和实时API, 带有一个包含登录和注册的简单JavaScript前端. 关于使用Feathers的完整细节, 或者开始构建自己的第一个Feathers应用程序, 请关注 <a class="reference internal" href="../../api/readme.html"><span class="doc">API</span></a> ！</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../auth/index.html" class="btn btn-neutral float-right" title="身份验证指南和食谱" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="frontend.html" class="btn btn-neutral float-left" title="建立一个前端" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>