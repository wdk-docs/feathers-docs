

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>建立一个前端 &mdash; feathers docs v2019.06.21 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="写测试" href="testing.html" />
    <link rel="prev" title="处理数据" href="processing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../contents.html" class="icon icon-home"> feathers docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Feathers[fɛðɚ]</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../readme.html">指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/index.html">Feathers 基础功能</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">创建聊天应用程序</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="readme.html">创建聊天应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="creating.html">创建应用程序</a></li>
<li class="toctree-l3"><a class="reference internal" href="service.html">创建服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="authentication.html">添加身份验证</a></li>
<li class="toctree-l3"><a class="reference internal" href="processing.html">处理数据</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">建立一个前端</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#set-up-the-index-page">设置索引页面</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connect-to-the-api">连接到API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#base-and-user-message-list-html">基础和用户/消息列表HTML</a></li>
<li class="toctree-l4"><a class="reference internal" href="#displaying-the-login-signup-or-chat-page">显示登录/注册或聊天页面</a></li>
<li class="toctree-l4"><a class="reference internal" href="#login-and-signup">登录和注册</a></li>
<li class="toctree-l4"><a class="reference internal" href="#real-time-and-sending-messages">实时和发送消息</a></li>
<li class="toctree-l4"><a class="reference internal" href="#whats-next">下一步是什么？</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">写测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../auth/index.html">身份验证指南和食谱</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/index.html">高级指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frameworks/readme.html">与前端框架集成</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../migrating.html">Feathers v3(秃鹰)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SECURITY.html">Feathers 安全</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Ecosystem/index.html">令人敬畏的Feathers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../help/readme.html">求助！</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/readme.html">常问问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/readme.html">特约</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">有许可证</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../github/index.html">github</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Summary.html">摘要</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../contents.html">feathers docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../contents.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">指南</a> &raquo;</li>
        
          <li><a href="index.html">创建聊天应用程序</a> &raquo;</li>
        
      <li>建立一个前端</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/guides/chat/frontend.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building-a-frontend">
<h1>建立一个前端<a class="headerlink" href="#building-a-frontend" title="永久链接至标题">¶</a></h1>
<p>正如我们在 <a class="reference internal" href="../basics/readme.html"><span class="doc">Feathers 基础知识</span></a> 中看到的,Feathers在浏览器中运行良好,并附带 <a class="reference internal" href="../basics/clients.html"><span class="doc">客户端使用</span></a>, 可以轻松连接到Feathers服务器.</p>
<p>在本章中,我们将使用现代纯JavaScript创建一个具有注册和登录功能的实时聊天前端.与 <a class="reference internal" href="../basics/readme.html"><span class="doc">Feathers 基础知识</span></a> 一样,它只适用于最新版本的 Chrome, Firefox, Safari 和 Edge,因为我们不会使用像 <a class="reference external" href="http://babeljs.io/">Babel</a> 这样的转换器. 最终版本可以在 <a class="reference external" href="https://github.com/feathersjs/feathers-chat/tree/master/public/vanilla">这里</a> 找到.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>我们不会使用前端框架,因此我们可以专注于Feathers的全部内容. Feathers是框架无关的,可以与React,VueJS或Angular等任何前端框架一起使用.有关更多信息,请参阅 <a class="reference internal" href="../frameworks/readme.html"><span class="doc">与前端框架集成</span></a>.</p>
</div>
<div class="section" id="set-up-the-index-page">
<h2>设置索引页面<a class="headerlink" href="#set-up-the-index-page" title="永久链接至标题">¶</a></h2>
<p>我们已经在 <code class="docutils literal notranslate"><span class="pre">public</span></code> 文件夹中提供静态文件,并在 <code class="docutils literal notranslate"><span class="pre">public/index.html</span></code> 中有一个占位符页面.让我们将其更新为以下内容:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span>
      <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Vanilla JavaScript Feathers Chat<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;favicon.ico&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;//cdn.rawgit.com/feathersjs/feathers-chat/v0.2.0/public/base.css&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;//cdn.rawgit.com/feathersjs/feathers-chat/v0.2.0/public/chat.css&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;app&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;flex flex-column&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;//unpkg.com/@feathersjs/client@^3.0.0/dist/feathers.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;app.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>这将加载我们的聊天CSS样式,添加容器 div <code class="docutils literal notranslate"><span class="pre">＃app</span></code> 并加载几个库:</p>
<ul class="simple">
<li><p>The <a class="reference internal" href="../basics/clients.html"><span class="doc">客户端使用</span></a> (since we
are not using a module loader like Webpack or Browserify)</p></li>
<li><p>Socket.io由聊天API提供</p></li>
<li><p><a class="reference external" href="https://momentjs.com/">MomentJS</a> 来格式化日期</p></li>
<li><p>我们的代码生成的 <code class="docutils literal notranslate"><span class="pre">app.js</span></code></p></li>
</ul>
<p>让我们创建 <code class="docutils literal notranslate"><span class="pre">public/app.js</span></code>,其中所有以下代码都将存在(每个代码示例都添加到该文件的末尾).</p>
</div>
<div class="section" id="connect-to-the-api">
<h2>连接到API<a class="headerlink" href="#connect-to-the-api" title="永久链接至标题">¶</a></h2>
<p>我们首先从最重要的事情开始,即与Feathers API的连接.我们已经在 <a class="reference internal" href="../basics/readme.html"><span class="doc">Feathers 基础知识</span></a> 中学习了如何在客户端上使用Feathers.在这里,我们做了几乎相同的事情:建立一个Socket连接并初始化一个新的Feathers应用程序.我们还为以后设置了身份验证客户端:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Establish a Socket.io connection</span>
<span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">();</span>
<span class="c1">// Initialize our Feathers client application through Socket.io</span>
<span class="c1">// with hooks and authentication.</span>
<span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">feathers</span><span class="p">();</span>

<span class="nx">client</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">feathers</span><span class="p">.</span><span class="nx">socketio</span><span class="p">(</span><span class="nx">socket</span><span class="p">));</span>
<span class="c1">// Use localStorage to store our login token</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="nx">feathers</span><span class="p">.</span><span class="nx">authentication</span><span class="p">({</span>
  <span class="nx">storage</span><span class="o">:</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span>
<span class="p">}));</span>
</pre></div>
</div>
<p>这允许我们通过websockets与聊天API通信,以进行实时更新.</p>
</div>
<div class="section" id="base-and-user-message-list-html">
<h2>基础和用户/消息列表HTML<a class="headerlink" href="#base-and-user-message-list-html" title="永久链接至标题">¶</a></h2>
<p>接下来,我们必须定义一些静态和动态HTML,当我们想要显示登录页面(也可以作为注册页面)和实际聊天界面时,我们可以将其插入到页面中:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Login screen</span>
<span class="kr">const</span> <span class="nx">loginHTML</span> <span class="o">=</span> <span class="sb">`&lt;main class=&quot;login container&quot;&gt;</span>
<span class="sb">  &lt;div class=&quot;row&quot;&gt;</span>
<span class="sb">    &lt;div class=&quot;col-12 col-6-tablet push-3-tablet text-center heading&quot;&gt;</span>
<span class="sb">      &lt;h1 class=&quot;font-100&quot;&gt;Log in or signup&lt;/h1&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">  &lt;div class=&quot;row&quot;&gt;</span>
<span class="sb">    &lt;div class=&quot;col-12 col-6-tablet push-3-tablet col-4-desktop push-4-desktop&quot;&gt;</span>
<span class="sb">      &lt;form class=&quot;form&quot;&gt;</span>
<span class="sb">        &lt;fieldset&gt;</span>
<span class="sb">          &lt;input class=&quot;block&quot; type=&quot;email&quot; name=&quot;email&quot; placeholder=&quot;email&quot;&gt;</span>
<span class="sb">        &lt;/fieldset&gt;</span>

<span class="sb">        &lt;fieldset&gt;</span>
<span class="sb">          &lt;input class=&quot;block&quot; type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot;password&quot;&gt;</span>
<span class="sb">        &lt;/fieldset&gt;</span>

<span class="sb">        &lt;button type=&quot;button&quot; id=&quot;login&quot; class=&quot;button button-primary block signup&quot;&gt;</span>
<span class="sb">          Log in</span>
<span class="sb">        &lt;/button&gt;</span>

<span class="sb">        &lt;button type=&quot;button&quot; id=&quot;signup&quot; class=&quot;button button-primary block signup&quot;&gt;</span>
<span class="sb">          Sign up and log in</span>
<span class="sb">        &lt;/button&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">&lt;/main&gt;`</span><span class="p">;</span>

<span class="c1">// Chat base HTML (without user list and messages)</span>
<span class="kr">const</span> <span class="nx">chatHTML</span> <span class="o">=</span> <span class="sb">`&lt;main class=&quot;flex flex-column&quot;&gt;</span>
<span class="sb">  &lt;header class=&quot;title-bar flex flex-row flex-center&quot;&gt;</span>
<span class="sb">    &lt;div class=&quot;title-wrapper block center-element&quot;&gt;</span>
<span class="sb">      &lt;img class=&quot;logo&quot; src=&quot;http://feathersjs.com/img/feathers-logo-wide.png&quot;</span>
<span class="sb">        alt=&quot;Feathers Logo&quot;&gt;</span>
<span class="sb">      &lt;span class=&quot;title&quot;&gt;Chat&lt;/span&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/header&gt;</span>

<span class="sb">  &lt;div class=&quot;flex flex-row flex-1 clear&quot;&gt;</span>
<span class="sb">    &lt;aside class=&quot;sidebar col col-3 flex flex-column flex-space-between&quot;&gt;</span>
<span class="sb">      &lt;header class=&quot;flex flex-row flex-center&quot;&gt;</span>
<span class="sb">        &lt;h4 class=&quot;font-300 text-center&quot;&gt;</span>
<span class="sb">          &lt;span class=&quot;font-600 online-count&quot;&gt;0&lt;/span&gt; users</span>
<span class="sb">        &lt;/h4&gt;</span>
<span class="sb">      &lt;/header&gt;</span>

<span class="sb">      &lt;ul class=&quot;flex flex-column flex-1 list-unstyled user-list&quot;&gt;&lt;/ul&gt;</span>
<span class="sb">      &lt;footer class=&quot;flex flex-row flex-center&quot;&gt;</span>
<span class="sb">        &lt;a href=&quot;#&quot; id=&quot;logout&quot; class=&quot;button button-primary&quot;&gt;</span>
<span class="sb">          Sign Out</span>
<span class="sb">        &lt;/a&gt;</span>
<span class="sb">      &lt;/footer&gt;</span>
<span class="sb">    &lt;/aside&gt;</span>

<span class="sb">    &lt;div class=&quot;flex flex-column col col-9&quot;&gt;</span>
<span class="sb">      &lt;main class=&quot;chat flex flex-column flex-1 clear&quot;&gt;&lt;/main&gt;</span>

<span class="sb">      &lt;form class=&quot;flex flex-row flex-space-between&quot; id=&quot;send-message&quot;&gt;</span>
<span class="sb">        &lt;input type=&quot;text&quot; name=&quot;text&quot; class=&quot;flex flex-1&quot;&gt;</span>
<span class="sb">        &lt;button class=&quot;button-primary&quot; type=&quot;submit&quot;&gt;Send&lt;/button&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">    &lt;/div&gt;</span>
<span class="sb">  &lt;/div&gt;</span>
<span class="sb">&lt;/main&gt;`</span><span class="p">;</span>

<span class="c1">// Add a new user to the list</span>
<span class="kr">const</span> <span class="nx">addUser</span> <span class="o">=</span> <span class="nx">user</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">userList</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.user-list&#39;</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">userList</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add the user to the list</span>
    <span class="nx">userList</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="s1">&#39;beforeend&#39;</span><span class="p">,</span> <span class="sb">`&lt;li&gt;</span>
<span class="sb">      &lt;a class=&quot;block relative&quot; href=&quot;#&quot;&gt;</span>
<span class="sb">        &lt;img src=&quot;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">&quot; alt=&quot;&quot; class=&quot;avatar&quot;&gt;</span>
<span class="sb">        &lt;span class=&quot;absolute username&quot;&gt;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">      &lt;/a&gt;</span>
<span class="sb">    &lt;/li&gt;`</span><span class="p">);</span>

    <span class="c1">// Update the number of users</span>
    <span class="kr">const</span> <span class="nx">userCount</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.user-list li&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.online-count&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">userCount</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Renders a new message and finds the user that belongs to the message</span>
<span class="kr">const</span> <span class="nx">addMessage</span> <span class="o">=</span> <span class="nx">message</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Find the user belonging to this message or use the anonymous user if not found</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">chat</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.chat&#39;</span><span class="p">);</span>
  <span class="c1">// Escape HTML</span>
  <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">text</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;amp;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">chat</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chat</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span> <span class="s1">&#39;beforeend&#39;</span><span class="p">,</span> <span class="sb">`&lt;div class=&quot;message flex flex-row&quot;&gt;</span>
<span class="sb">      &lt;img src=&quot;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">avatar</span><span class="si">}</span><span class="sb">&quot; alt=&quot;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">&quot; class=&quot;avatar&quot;&gt;</span>
<span class="sb">      &lt;div class=&quot;message-wrapper&quot;&gt;</span>
<span class="sb">        &lt;p class=&quot;message-header&quot;&gt;</span>
<span class="sb">          &lt;span class=&quot;username font-600&quot;&gt;</span><span class="si">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">          &lt;span class=&quot;sent-date font-300&quot;&gt;</span><span class="si">${</span><span class="nx">moment</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;MMM Do, hh:mm:ss&#39;</span><span class="p">)</span><span class="si">}</span><span class="sb">&lt;/span&gt;</span>
<span class="sb">        &lt;/p&gt;</span>
<span class="sb">        &lt;p class=&quot;message-content font-300&quot;&gt;</span><span class="si">${</span><span class="nx">text</span><span class="si">}</span><span class="sb">&lt;/p&gt;</span>
<span class="sb">      &lt;/div&gt;</span>
<span class="sb">    &lt;/div&gt;`</span><span class="p">);</span>

    <span class="nx">chat</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">scrollHeight</span> <span class="o">-</span> <span class="nx">chat</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>这将添加以下变量和函数:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">loginHTML</span></code> 包含登录/注册页面的一些静态HTML</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chatHTML</span></code> 包含主要的聊天页面内容(一旦用户登录)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">addUser(user)</span></code> 是一个将新用户添加到左侧用户列表的函数</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">addMessage(message)</span></code> 是一个向列表中添加新消息的函数.它还将确保在添加消息时始终滚动到消息列表的底部</p></li>
</ul>
</div>
<div class="section" id="displaying-the-login-signup-or-chat-page">
<h2>显示登录/注册或聊天页面<a class="headerlink" href="#displaying-the-login-signup-or-chat-page" title="永久链接至标题">¶</a></h2>
<p>接下来,我们将添加两个功能来显示登录和聊天页面,其中我们还将添加25个最新聊天消息和注册用户的列表.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Show the login page</span>
<span class="kr">const</span> <span class="nx">showLogin</span> <span class="o">=</span> <span class="p">(</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.login&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;.heading&#39;</span><span class="p">).</span><span class="nx">insertAdjacentHTML</span><span class="p">(</span><span class="s1">&#39;beforeend&#39;</span><span class="p">,</span> <span class="sb">`&lt;p&gt;There was an error: </span><span class="si">${</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="si">}</span><span class="sb">&lt;/p&gt;`</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">loginHTML</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Shows the chat page</span>
<span class="kr">const</span> <span class="nx">showChat</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">chatHTML</span><span class="p">;</span>

  <span class="c1">// Find the latest 25 messages. They will come with the newest first</span>
  <span class="c1">// which is why we have to reverse before adding them</span>
  <span class="kr">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span>
    <span class="nx">query</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">$sort</span><span class="o">:</span> <span class="p">{</span> <span class="nx">createdAt</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">},</span>
      <span class="nx">$limit</span><span class="o">:</span> <span class="mi">25</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="c1">// We want to show the newest message last</span>
  <span class="nx">messages</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">addMessage</span><span class="p">);</span>

  <span class="c1">// Find all users</span>
  <span class="kr">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">();</span>

  <span class="nx">users</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">addUser</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">showLogin(error)</span></code> 将显示loginHTML的内容,或者,如果登录页面已经显示,则添加错误消息.当您尝试使用无效凭据登录或使用已存在的用户注册时,会发生这种情况.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">showChat()</span></code> does several things. First, we add the static chatHTML
to the page. Then we get the latest 25 messages from the messages
Feathers service (this is the same as the <code class="docutils literal notranslate"><span class="pre">/messages</span></code> endpoint of
our chat API) using the Feathers query syntax. Since the list will
come back with the newest message first, we need to reverse the data.
Then we add each message by calling our <code class="docutils literal notranslate"><span class="pre">addMessage</span></code> function so
that it looks like a chat app should — with old messages getting
older as you scroll up. After that we get a list of all registered
users to show them in the sidebar by calling addUser.</p></li>
</ul>
</div>
<div class="section" id="login-and-signup">
<h2>登录和注册<a class="headerlink" href="#login-and-signup" title="永久链接至标题">¶</a></h2>
<p>好的.现在我们可以显示登录页面(包括出错时的错误消息),如果我们登录,则调用上面定义的 <code class="docutils literal notranslate"><span class="pre">showChat</span></code>.我们已经构建了UI,现在我们必须添加功能以实际允许人们注册,登录和注销.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// Retrieve email/password object from the login/signup page</span>
<span class="kr">const</span> <span class="nx">getCredentials</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">email</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;[name=&quot;email&quot;]&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
    <span class="nx">password</span><span class="o">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;[name=&quot;password&quot;]&#39;</span><span class="p">).</span><span class="nx">value</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Log in either using the given email/password or the token from storage</span>
<span class="kr">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">credentials</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">credentials</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Try to authenticate using the JWT from localStorage</span>
      <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// If we get login information, add the strategy we want to use for login</span>
      <span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({</span> <span class="nx">strategy</span><span class="o">:</span> <span class="s1">&#39;local&#39;</span> <span class="p">},</span> <span class="nx">credentials</span><span class="p">);</span>

      <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// If successful, show the chat page</span>
    <span class="nx">showChat</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If we got an error, show the login page</span>
    <span class="nx">showLogin</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="nx">ev</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">&#39;signup&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// For signup, create a new user and then log them in</span>
    <span class="kr">const</span> <span class="nx">credentials</span> <span class="o">=</span> <span class="nx">getCredentials</span><span class="p">();</span>

    <span class="c1">// First create the user</span>
    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">(</span><span class="nx">credentials</span><span class="p">);</span>
    <span class="c1">// If successful log them in</span>
    <span class="nx">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">credentials</span><span class="p">);</span>

    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">case</span> <span class="s1">&#39;login&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">getCredentials</span><span class="p">();</span>

    <span class="nx">await</span> <span class="nx">login</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>

    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">case</span> <span class="s1">&#39;logout&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">loginHTML</span><span class="p">;</span>

    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">getCredentials()</span></code> 从登录/注册页面获取用户名(电子邮件)和密码字段的值,以便直接与Feathers身份验证一起使用.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">login(credentials)</span></code> will either authenticate the credentials
returned by getCredentials against our Feathers API using the local
authentication strategy (e.g. username and password) or, if no
credentials are given, try and use the JWT stored in localStorage.
This will try and get the JWT from localStorage first where it is put
automatically once you log in successfully so that we don’t have to
log in every time we visit the chat. Only if that doesn’t work it
will show the login page. Finally, if the login was successful it
will show the chat page.</p></li>
<li><p>我们还为三个按钮添加了单击事件侦听器. <a href="#id1"><span class="problematic" id="id2">``</span></a>login``将获得凭据,然后使用这些凭据登录.单击“#regup”将注册并同时登录.它将首先在我们的API上创建一个新用户,然后使用相同的用户信息登录.最后,``#logout``将忘记JWT,然后再次显示登录页面.</p></li>
</ul>
</div>
<div class="section" id="real-time-and-sending-messages">
<h2>实时和发送消息<a class="headerlink" href="#real-time-and-sending-messages" title="永久链接至标题">¶</a></h2>
<p>在最后一步中,我们将添加发送新消息的功能,并使用户和消息列表实时更新.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;submit&#39;</span><span class="p">,</span> <span class="nx">async</span> <span class="nx">ev</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;send-message&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This is the message text input field</span>
    <span class="kr">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;[name=&quot;text&quot;]&#39;</span><span class="p">);</span>

    <span class="nx">ev</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="c1">// Create a new message and then clear the input field</span>
    <span class="nx">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">text</span><span class="o">:</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">});</span>

    <span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Listen to created events and add the new message in real-time</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;messages&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="nx">addMessage</span><span class="p">);</span>

<span class="c1">// We will also see when new users get created in real-time</span>
<span class="nx">client</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="nx">addUser</span><span class="p">);</span>

<span class="nx">login</span><span class="p">();</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">submit</span></code> 按钮事件监听器从输入字段获取消息文本,在消息服务上创建新消息,然后清除该字段.</p></li>
<li><p>接下来,我们添加了两个 <code class="docutils literal notranslate"><span class="pre">created</span></code> 事件监听器.一个用于 <code class="docutils literal notranslate"><span class="pre">messages</span></code> 调用 <code class="docutils literal notranslate"><span class="pre">addMessage</span></code> 函数将新消息添加到列表中,一个用于 <code class="docutils literal notranslate"><span class="pre">users</span></code>,它通过 <code class="docutils literal notranslate"><span class="pre">addUser</span></code> 将用户添加到列表中.这就是Feathers实时和我们需要做的一切,以便让所有内容自动更新.</p></li>
<li><p>为了启动我们的应用程序,我们调用 <code class="docutils literal notranslate"><span class="pre">login()</span></code> ,如上所述,它将立即显示聊天应用程序(如果我们之前已登录且令牌未过期)或登录页面.</p></li>
</ul>
</div>
<div class="section" id="whats-next">
<h2>下一步是什么？<a class="headerlink" href="#whats-next" title="永久链接至标题">¶</a></h2>
<p>而已.我们现在有一个简单的JavaScript实时聊天前端登录和注册.此示例演示了如何与Feathers API进行交互的许多核心原则.</p>
<p>如果您遇到问题, 请记住您可以在 <a class="reference external" href="https://github.com/feathersjs/feathers-chat">这里</a> 找到一个完整的工作示例.</p>
<p>在最后一章中,我们将看看 <a class="reference internal" href="testing.html"><span class="doc">写测试</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="写测试" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="processing.html" class="btn btn-neutral float-left" title="处理数据" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, BandCap

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>